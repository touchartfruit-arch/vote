<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚æŠ•ç¥¨æ’è¡Œæ¦œ</title>
    <style>
        body { font-family: sans-serif; background: #eee; padding: 10px; text-align: center; }
        .list-item { display: flex; align-items: center; background: white; margin: 8px 0; padding: 12px; border-radius: 10px; text-align: left; }
        .votes { margin-left: auto; font-weight: bold; color: #f39c12; }
        button { margin-left: 10px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #time-display { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .loading-mask { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:100; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>
    <h2>ğŸ† å³æ™‚ç«¶è³½æ’å</h2>
    <div id="time-display">è¼‰å…¥æ™‚é–“ï¼š--/-- --:--:--</div>
    
    <div id="board">è¼‰å…¥ä¸­...</div>

    <div id="mask" class="loading-mask">
        <h2 style="color:#28a745;">âœ… æŠ•ç¥¨æˆåŠŸï¼</h2>
        <p>æ­£åœ¨ç‚ºæ‚¨é–‹å•Ÿå³æ™‚çµ±è¨ˆåœ–è¡¨...</p>
    </div>

    <script>
        const GAS_URL ="https://script.google.com/macros/s/AKfycbxdACnIEYaFatj83Qx8mYe1tGLtJZQJ37Xx8le43D8IglAJRrGqrr9bYU4FdrEnNwzQtQ/exec";
        // é€™æ˜¯ä½ å‰›å‰›å¾è©¦ç®—è¡¨ç™¼å¸ƒåœ–è¡¨ç²å¾—çš„ç¶²å€
        // ä¿®æ”¹ index.html è£¡çš„é€™ä¸€è¡Œ
        const CHART_URL = "https://touchartfruit-arch.github.io/vote/result.html"; 

        const urlParams = new URLSearchParams(window.location.search);
        let myToken = urlParams.get('token') || localStorage.getItem('v_token');

        // æ›´æ–°æ™‚é–“çš„å‡½å¼
        function updateTime() {
            const now = new Date();
            const timeStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            document.getElementById('time-display').innerText = `æœ€å¾Œæ›´æ–°ï¼š${timeStr}`;
        }

        async function fetchBoard() {
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                const board = document.getElementById('board');
                board.innerHTML = '';
                data.teams.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `<span>${t.name}</span><span class="votes">${t.votes} ç¥¨</span><button onclick="vote('${t.name}')">æŠ•ç¥¨</button>`;
                    board.appendChild(item);
                });
                updateTime(); // æ¯æ¬¡åˆ·æ–°è³‡æ–™å°±æ›´æ–°æ™‚é–“
            } catch(e) { console.error("æ›´æ–°å¤±æ•—"); }
        }

        async function vote(teamName) {
            if (!myToken) return alert("è«‹å…ˆæƒç¢¼é ˜å–å¯†ç¢¼");
            if (!confirm(`ç¢ºå®šæŠ•çµ¦ ${teamName}ï¼Ÿ`)) return;

            // é¡¯ç¤ºæˆåŠŸè·³è½‰é®ç½©
            document.getElementById('mask').style.display = 'flex';

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ token: myToken, teamName: teamName })
                });
                const result = await res.json();
                
                if (result.status === "success") {
                    localStorage.removeItem('v_token');
                    // 1.5ç§’å¾Œè·³è½‰è‡³åœ–è¡¨é é¢
                    setTimeout(() => {
                        window.location.href = CHART_URL;
                    }, 1500);
                } else {
                    alert(result.message);
                    document.getElementById('mask').style.display = 'none';
                }
            } catch (e) {
                alert("ç³»çµ±éŒ¯èª¤");
                document.getElementById('mask').style.display = 'none';
            }
        }

        fetchBoard();
        setInterval(fetchBoard, 5000); // æ¯5ç§’è‡ªå‹•åŒæ­¥ä¸€æ¬¡æ™‚é–“èˆ‡ç¥¨æ•¸
    </script>
</body>
</html>



